@model StudentManagementSystem.ViewModels.ClassDetailsViewModel
@{
    ViewData["Title"] = "Chi ti·∫øt l·ªõp h·ªçc";
}

@section Styles {
    <link href="~/css/teacher-ui.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" rel="stylesheet" />
}

<div class="teacher-page-container">
    <!-- Welcome Header -->
    <div class="welcome-header mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <div class="position-relative z-index-2">
                <h2 class="mb-2 animate__animated animate__fadeInLeft fw-bold">
                    <i class="fas fa-school me-2"></i>
                    @Model.Class.ClassName üè´
                </h2>
                <p class="mb-0 opacity-75">Chi ti·∫øt th√¥ng tin l·ªõp h·ªçc v√† qu·∫£n l√Ω sinh vi√™n</p>
            </div>
            <div class="text-end position-relative z-index-2">
                <div class="d-flex gap-2 flex-wrap">
                    <a href="@Url.Action("CreateAttendanceSession", new { classId = Model.Class.Id })" class="btn btn-light btn-lg px-4 py-2 rounded-pill shadow-sm">
                        <i class="fas fa-plus me-2"></i>T·∫°o bu·ªïi h·ªçc
                    </a>
                    <a href="@Url.Action("StudentGrades", new { classId = Model.Class.Id })" class="btn btn-outline-light btn-lg px-4 py-2 rounded-pill">
                        <i class="fas fa-star me-2"></i>Qu·∫£n l√Ω ƒëi·ªÉm
                    </a>
                    <a href="@Url.Action("MyClasses")" class="btn btn-outline-light btn-lg px-4 py-2 rounded-pill">
                        <i class="fas fa-arrow-left me-2"></i>Quay l·∫°i
                    </a>
                </div>
            </div>
        </div>
    </div>

@if (TempData["Success"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["Success"]
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Th√¥ng tin l·ªõp h·ªçc -->
<div class="row mb-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-info-circle"></i> Th√¥ng tin l·ªõp h·ªçc</h5>
            </div>
            <div class="card-body">
                <dl class="row">
                    <dt class="col-sm-3">M√¥n h·ªçc:</dt>
                    <dd class="col-sm-9">
                        @foreach (var classSubject in Model.Class.ClassSubjects)
                        {
                            <span class="badge bg-primary me-1">@classSubject.Subject.SubjectName (@classSubject.Subject.SubjectCode)</span>
                        }
                    </dd>

                    <dt class="col-sm-3">H·ªçc k·ª≥:</dt>
                    <dd class="col-sm-9">@Model.Class.Semester - @Model.Class.Year</dd>

                    <dt class="col-sm-3">Gi·∫£ng vi√™n:</dt>
                    <dd class="col-sm-9">@Model.Class.TeacherUser.FirstName @Model.Class.TeacherUser.LastName</dd>

                    <dt class="col-sm-3">S·ªë t√≠n ch·ªâ:</dt>
                    <dd class="col-sm-9">@Model.Class.ClassSubjects.Sum(cs => cs.Subject.Credits)</dd>
                    
                    <dt class="col-sm-3">M√¥ t·∫£:</dt>
                    <dd class="col-sm-9">@(string.IsNullOrEmpty(Model.Class.Description) ? "Ch∆∞a c√≥ m√¥ t·∫£" : Model.Class.Description)</dd>
                </dl>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-chart-bar"></i> Th·ªëng k√™</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">@Model.TotalStudents</h4>
                        <small class="text-muted">Sinh vi√™n</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">@Model.TotalSessions</h4>
                        <small class="text-muted">Bu·ªïi h·ªçc</small>
                    </div>
                    <div class="col-12">
                        <h4 class="text-info">@Model.OverallAttendanceRate.ToString("F1")%</h4>
                        <small class="text-muted">T·ª∑ l·ªá ƒëi·ªÉm danh</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabs Navigation -->
<ul class="nav nav-tabs" id="classDetailsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="sessions-tab" data-bs-toggle="tab" data-bs-target="#sessions" type="button" role="tab">
            <i class="fas fa-calendar-alt"></i> Bu·ªïi h·ªçc (@Model.AttendanceSessions.Count)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
            <i class="fas fa-users"></i> Sinh vi√™n (@Model.TotalStudents)
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="grades-tab" data-bs-toggle="tab" data-bs-target="#grades" type="button" role="tab">
            <i class="fas fa-star"></i> ƒêi·ªÉm s·ªë
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="exams-tab" data-bs-toggle="tab" data-bs-target="#exams" type="button" role="tab">
            <i class="fas fa-file-alt"></i> B√†i ki·ªÉm tra
        </button>
    </li>
</ul>

<div class="tab-content" id="classDetailsTabContent">
    <!-- Sessions Tab -->
    <div class="tab-pane fade show active" id="sessions" role="tabpanel">
        <div class="card border-top-0">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Danh s√°ch bu·ªïi h·ªçc</h5>
            </div>
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-calendar-alt"></i> Danh s√°ch bu·ªïi h·ªçc (@Model.AttendanceSessions.Count)</h5>
            </div>
            <div class="card-body">
                @if (Model.AttendanceSessions.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Ti√™u ƒë·ªÅ</th>
                                    <th>Ng√†y h·ªçc</th>
                                    <th>Th·ªùi gian</th>
                                    <th>Ph√≤ng</th>
                                    <th>ƒêi·ªÉm danh</th>
                                    <th>Thao t√°c</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var session in Model.AttendanceSessions)
                                {
                                    <tr>
                                        <td>
                                            <strong>@session.SessionTitle</strong>
                                            @if (!string.IsNullOrEmpty(session.Description))
                                            {
                                                <br><small class="text-muted">@session.Description</small>
                                            }
                                        </td>
                                        <td>@session.SessionDate.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @session.StartTime.ToString(@"hh\:mm") - @session.EndTime.ToString(@"hh\:mm")
                                        </td>
                                        <td>@session.Location</td>
                                        <td>
                                            @if (session.IsCompleted)
                                            {
                                                <span class="badge bg-success">
                                                    @session.GetPresentStudents()/@session.GetTotalStudents()
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-warning">Ch∆∞a ƒëi·ªÉm danh</span>
                                            }
                                        </td>
                                        <td>
                                            <a href="@Url.Action("TakeAttendance", new { sessionId = session.Id })"
                                               class="btn btn-sm btn-primary">
                                                <i class="fas fa-check"></i> ƒêi·ªÉm danh
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-calendar-plus fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Ch∆∞a c√≥ bu·ªïi h·ªçc n√†o</p>
                        <a href="@Url.Action("CreateAttendanceSession", new { classId = Model.Class.Id })" class="btn btn-success">
                            <i class="fas fa-plus"></i> T·∫°o bu·ªïi h·ªçc ƒë·∫ßu ti√™n
                        </a>
                    </div>
                }
            </div>
        </div>
    </div>
    <!-- Students Tab -->
    <div class="tab-pane fade" id="students" role="tabpanel">
        <div class="card border-top-0">
            <div class="card-header">
                <h5><i class="fas fa-users"></i> Danh s√°ch sinh vi√™n (@Model.Students.Count)</h5>
            </div>
            <div class="card-body">
                @if (Model.Students.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>M√£ SV</th>
                                    <th>H·ªç t√™n</th>
                                    <th>Email</th>
                                    <th>T·ª∑ l·ªá ƒëi·ªÉm danh</th>
                                    <th>Ng√†y tham gia</th>
                                    <th>Tr·∫°ng th√°i</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var student in Model.Students)
                                {
                                    <tr>
                                        <td><strong>@student.Student.StudentId</strong></td>
                                        <td>@student.Student.FullName</td>
                                        <td>@student.Student.Email</td>
                                        <td>
                                            @{
                                                var studentAttendances = Model.AttendanceSessions
                                                    .SelectMany(ats => ats.Attendances)
                                                    .Where(a => a.StudentUserId == student.StudentUserId);
                                                var presentCount = studentAttendances.Count(a => a.IsPresent);
                                                var totalCount = Model.AttendanceSessions.Count;
                                                var rate = totalCount > 0 ? (decimal)presentCount / totalCount * 100 : 0;
                                                var badgeClass = rate >= 80 ? "bg-success" : rate >= 60 ? "bg-warning" : "bg-danger";
                                            }
                                            <span class="badge @badgeClass">@rate.ToString("F0")%</span>
                                        </td>
                                        <td>@student.EnrolledAt.ToString("dd/MM/yyyy")</td>
                                        <td>
                                            @if (student.IsActive)
                                            {
                                                <span class="badge bg-success">Ho·∫°t ƒë·ªông</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-secondary">Ng·ª´ng h·ªçc</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <i class="fas fa-user-slash fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Ch∆∞a c√≥ sinh vi√™n n√†o trong l·ªõp</p>
                    </div>
                }
            </div>
        </div>
    </div>

    <!-- Grades Tab -->
    <div class="tab-pane fade" id="grades" role="tabpanel">
        <div class="card border-top-0">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-star"></i> Qu·∫£n l√Ω ƒëi·ªÉm s·ªë</h5>
                <a href="@Url.Action("StudentGrades", new { classId = Model.Class.Id })" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Nh·∫≠p ƒëi·ªÉm
                </a>
            </div>
            <div class="card-body">
                <div class="text-center py-4">
                    <i class="fas fa-star fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Qu·∫£n l√Ω ƒëi·ªÉm s·ªë h·ªçc k·ª≥</h5>
                    <p class="text-muted">Nh·∫≠p v√† qu·∫£n l√Ω ƒëi·ªÉm danh, ƒëi·ªÉm gi·ªØa k·ª≥, ƒëi·ªÉm cu·ªëi k·ª≥ cho sinh vi√™n</p>
                    <a href="@Url.Action("StudentGrades", new { classId = Model.Class.Id })" class="btn btn-primary">
                        <i class="fas fa-plus"></i> B·∫Øt ƒë·∫ßu nh·∫≠p ƒëi·ªÉm
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Exams Tab -->
    <div class="tab-pane fade" id="exams" role="tabpanel">
        <div class="card border-top-0">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5><i class="fas fa-file-alt"></i> B√†i ki·ªÉm tra</h5>
                <a href="@Url.Action("CreateSchedule", new { classId = Model.Class.Id })" class="btn btn-success">
                    <i class="fas fa-plus"></i> T·∫°o l·ªãch thi
                </a>
            </div>
            <div class="card-body">
                <div class="text-center py-4">
                    <i class="fas fa-file-alt fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">B√†i ki·ªÉm tra cho l·ªõp h·ªçc</h5>
                    <p class="text-muted">T·∫°o v√† qu·∫£n l√Ω c√°c b√†i ki·ªÉm tra, l·ªãch thi cho l·ªõp h·ªçc n√†y</p>
                    <div class="d-grid gap-2 d-md-block">
                        <a href="@Url.Action("CreateExam")" class="btn btn-primary">
                            <i class="fas fa-plus"></i> T·∫°o b√†i ki·ªÉm tra
                        </a>
                        <a href="@Url.Action("CreateSchedule", new { classId = Model.Class.Id })" class="btn btn-success">
                            <i class="fas fa-calendar-plus"></i> T·∫°o l·ªãch thi
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Auto refresh attendance status every 30 seconds
        setInterval(function() {
            location.reload();
        }, 30000);
    </script>
}
</div> <!-- End teacher-page-container -->
